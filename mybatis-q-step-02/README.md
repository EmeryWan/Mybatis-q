## å®ç°æ˜ å°„å™¨çš„æ³¨å†Œå’Œä½¿ç”¨


### â“ é—®é¢˜

æ€ä¹ˆå‘ŠçŸ¥ `MapperProxyFactory` å¯¹å“ªä¸ªæ¥å£è¿›è¡Œä»£ç†ï¼Ÿï¼ˆä¹‹å‰çš„å®ç°é€šè¿‡æ‰‹åŠ¨ä¼ å…¥ï¼‰
==> å¯¹ä¸€ä¸ªåŒ…è·¯å¾„ä¸‹çš„ Mapper è¿›è¡Œæ‰«æå’Œæ³¨å†Œï¼Ÿ


å¦‚ä½•å¯¹ `SqlSession` è¿›è¡Œè§„èŒƒåŒ–å¤„ç†ï¼Ÿï¼ˆä¹‹å‰æ˜¯å‡è®¾å¤„ç†ï¼šå®é™…è°ƒç”¨æ¥å£ã€è¿”å›çš„ç»“æœå†…å®¹ï¼‰
ï¼ˆ`SqlSession` å¯ä»¥æŠŠæ˜ å°„å™¨ä»£ç† `MapperProxy` å’Œæ–¹æ³•è°ƒç”¨è¿›è¡ŒåŒ…è£…ï¼Œå»ºç«‹ä¸€ä¸ªç”Ÿå‘½å‘¨æœŸæ¨¡å‹ç»“æ„ï¼‰


### ğŸ¨ è®¾è®¡


åˆ©ç”¨ä¸€ä¸ªæ³¨å†Œå™¨ç±» `MapperRegistry` æ‰«æåŒ…è·¯å¾„ä¸‹çš„æ¥å£ï¼Œå°†æ¯ä¸ªæ¥å£æ˜ å°„çš„ä»£ç†ç±»å­˜å…¥ç¼“å­˜ä¸­ï¼ˆ`HashMap`ï¼‰ã€‚

`SqlSession` ä¸­å®šä¹‰æ•°æ®åº“å¤„ç†æ¥å£ï¼Œå’Œè·å– Mapper å¯¹è±¡çš„æ“ä½œï¼Œå¹¶äº¤ç»™æ˜ å°„å™¨ä»£ç†ç±» `MapperProxy` ä½¿ç”¨ã€‚

![](../imgs/02/1.png)

- `MapperRegistry`

ï¼ˆ1ï¼‰æ‰«æåŒ…è·¯å¾„
ï¼ˆ2ï¼‰ä¸ºåŒ…è·¯å¾„ä¸‹çš„ Mapper æ¥å£åˆ›å»ºæ˜ å°„å™¨ä»£ç†å·¥å‚ `MapperProxyFactory`
ï¼ˆ3ï¼‰å°†ä»£ç†å·¥å‚æ”¾å…¥ç¼“å­˜ `knownMappers(HashMap)` ä¸­ï¼Œä¾›åˆ›å»º Mapper æ¥å£çš„ä»£ç†å¯¹è±¡ä½¿ç”¨
ï¼ˆ4ï¼‰`getMapper()` è°ƒç”¨ä»£ç†å·¥å‚åˆ›å»ºå¯¹åº” Mapper çš„ä»£ç†å¯¹è±¡

- `SqlSession`

`MapperRegistry` åªè´Ÿè´£å°† Mapper äº¤ç»™æŒ‡å®šçš„ä»£ç†å·¥å‚ï¼ŒçœŸæ­£æ‰§è¡Œ SQL æ“ä½œè¦ç”± `SqlSession` æ¥å®Œæˆã€‚

åœ¨ Mybatis ä¸­ï¼Œ`SqlSession` é€šå¸¸åŒ…å« Mapper çš„å¢åˆ æ”¹æŸ¥æ¥å£ã€äº‹åŠ¡ç®¡ç†æ“ä½œ

### ğŸ’¡ ç»“æœ

å®Œæˆå¯¹åŒ…è·¯å¾„ä¸‹ Mapper æ¥å£çš„æ‰«æå’Œä»£ç†å·¥å‚çš„åˆ›å»ºã€‚

å®Œå–„å¯¹ SqlSession çš„æ“ä½œï¼Œå¹¶åˆ›å»ºäº†é»˜è®¤å®ç° `DefaultSession` å’Œå¯¹åº”çš„ä»£ç†å·¥å‚ã€‚



```
mybatis-q-step-02
â””â”€â”€ src
    â”œâ”€â”€ main
    â”‚   â””â”€â”€ java
    â”‚       â””â”€â”€ cn.letout.mybatis
    â”‚           â”œâ”€â”€ binding
    â”‚           â”‚   â”œâ”€â”€ MapperProxy.java
    â”‚           â”‚   â”œâ”€â”€ MapperProxyFactory.java
    â”‚           â”‚   â””â”€â”€ MapperRegistry.java  # æ‰«æåŒ…è·¯å¾„ï¼›ç”ŸæˆåŒ…è·¯å¾„ä¸‹çš„æ¥å£å¯¹åº”çš„ MapperProxyFactoryï¼Œå¹¶ç¼“å­˜åˆ° Map ä¸­
    â”‚           â””â”€â”€ session
    â”‚               â”œâ”€â”€ defaults
    â”‚               â”‚   â”œâ”€â”€ DefaultSqlSession.java  # SqlSession é»˜è®¤å®ç°ã€‚ä½œç”¨ï¼šï¼ˆ1ï¼‰è·å– Mapper çš„ä»£ç†å¯¹è±¡ï¼›ï¼ˆ2ï¼‰ç›´æ¥æˆ–é—´æ¥åœ°åˆ©ç”¨ä»£ç†å¯¹è±¡ï¼Œæ‰§è¡Œä¸€äº›é€šç”¨æ•°æ®åº“æ“ä½œ
    â”‚               â”‚   â””â”€â”€ DefaultSqlSessionFactory.java
    â”‚               â”œâ”€â”€ SqlSession.java  # å®šä¹‰æ‰§è¡Œ SQL çš„æ ‡å‡†ï¼›è·å– Mapperï¼›ç®¡ç†äº‹åŠ¡ç­‰æ“ä½œï¼ˆæ¥å£ï¼‰
    â”‚               â””â”€â”€ SqlSessionFactory.java
    â””â”€â”€ test
```